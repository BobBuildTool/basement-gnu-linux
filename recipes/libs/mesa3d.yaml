inherit: [meson, wayland-scanner]

metaEnvironment:
    PKG_VERSION: "24.2.8"
    PKG_LICENSE: "MIT, SGI, Khronos"

Config:
    MESA3D_GALLIUM_DRIVERS:
        help: "List of gallium drivers to build"
        type: str
        # crocus,etnaviv,freedreno,i915,iris,lima,nouveau,panfrost,r300,r600,radeonsi,svga,softpipe,llvmpipe,tegra,v3d,vc4,virgl
        # this is the maximum we support right now:
        default: "crocus,lima,panfrost,svga,nouveau,tegra,v3d,vc4,virgl"

depends:
    - libs::zlib-dev
    - virtual::libs::libdrm-dev
    - graphics::wayland::wayland-protocols
    - graphics::wayland::wayland-dev

    - tools:
          target-toolchain: host-compat-toolchain
      depends:
          - python::mako
          - python::pyyaml
          - python::pycparser

    - use: []
      depends:
          - libs::zlib-tgt
          - virtual::libs::libdrm-tgt
          - graphics::wayland::wayland-tgt

checkoutSCM:
    scm: url
    url: https://archive.mesa3d.org/mesa-${PKG_VERSION}.tar.xz
    digestSHA1: c7994d1bf40879518b6ae331dd92e04b6e9d436e
    stripComponents: 1

buildTools: [bison, flex, m4]
buildVars: [MESA3D_GALLIUM_DRIVERS]
buildScript: |
    mesonBuild $1 \
        -Dglx=disabled \
        -Dgallium-xa=disabled \
        -Dglvnd=disabled \
        -Dgallium-opencl=disabled \
        -Dgallium-drivers="$MESA3D_GALLIUM_DRIVERS" \
        -Dvulkan-drivers="" \
        -Dplatforms=wayland \
        -Dgbm=enabled \
        -Degl=enabled \
        -Dopengl=false \
        -Dshared-glapi=enabled \
        -Dgles1=enabled \
        -Dgles2=enabled

multiPackage:
    "":
        depends:
            - name: libs::mesa3d-tgt
              use: []
        packageScript: mesonPackageBin
        provideDeps: [ "*-tgt" ]

    dev:
        packageScript: mesonPackageDev
        provideDeps: [ "*-dev" ]

    tgt:
        packageScript: mesonPackageLib
        provideDeps: [ "*-tgt" ]
