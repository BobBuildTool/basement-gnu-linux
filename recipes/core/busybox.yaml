inherit: [make, install, kconfig, patch]

depends:
    - if: "${BUSYBOX_CUSTOM_CONFIG:-}"
      name: "${BUSYBOX_CUSTOM_CONFIG_PKG:-core::busybox-custom-config}"

metaEnvironment:
    PKG_VERSION: "1.37.0"
    PKG_LICENSE: "GPL-2.0, bzip2-1.0.4"

checkoutSCM:
    scm: url
    url: https://busybox.net/downloads/busybox-${PKG_VERSION}.tar.bz2
    digestSHA1: "50efee4e4438b8aea90ea6895dac818d23125549"
    stripComponents: 1

checkoutDeterministic: True
checkoutScript: |
    patchApplySeries $<@busybox/*.patch@>

buildTools: [host-toolchain, target-toolchain]
buildVars: [BUSYBOX_CONFIG, BUSYBOX_CUSTOM_CONFIG, BUSYBOX_CUSTOM_CONFIG_PKG, BASEMENT_DEBUG,
            ARCH, CFLAGS, CROSS_COMPILE, LDFLAGS]
buildScript: |
    # prevent timestamps in configuration
    export KCONFIG_NOTIMESTAMP=1

    mkdir -p build install
    pushd build

    # where does the config come from?
    if [[ ${BUSYBOX_CUSTOM_CONFIG:+true} ]] ; then
        PKG="${BUSYBOX_CUSTOM_CONFIG_PKG:-core::busybox-custom-config}"
        CFG="${BOB_DEP_PATHS[$PKG]}/$BUSYBOX_CUSTOM_CONFIG"
    elif [[ ${BUSYBOX_CONFIG:+true} ]] ; then
        CFG="$1/configs/${BUSYBOX_CONFIG}"
    else
        CFG="defconfig"
    fi

    # check if the defconfig exists
    if [[ ! -f "$CFG" ]]; then
        >&2 echo "Don't know how to use '$CFG' as busybox config!"
        false
    fi

    # check if the source defconfig changed
    if [[ ! -f .config || .config -ot $CFG ]]; then
        cp -u $CFG .config
        # enable debug symbols if requested
        [[ ${BASEMENT_DEBUG:-0} != "0" ]] && kconfigEnable CONFIG_DEBUG
        make -C $1 O=$PWD \
            oldconfig
    fi

    makeParallel CONFIG_PREFIX=${BOB_CWD}/install \
        install

    popd #build

    if [[ -f build/busybox_unstripped ]] ; then
        mkdir install/bin/.debug
        cp build/busybox_unstripped install/bin/.debug/busybox
        ${CROSS_COMPILE}objcopy --add-gnu-debuglink=install/bin/.debug/busybox install/bin/busybox
    fi

    mkdir -p install/.bob

    # busybox must be setuid if configured
    if kconfigIsSet CONFIG_FEATURE_SUID build/.config; then
        printf '/usr/bin/busybox f 4755 0  0 - - - - -\n' > install/.bob/busybox.device-table
    fi

    # add configured shells
    printf '/bin/sh\n/usr/bin/sh\n' > install/.bob/busybox.shell-table
    if kconfigIsSet CONFIG_SHELL_ASH build/.config; then
        printf '/bin/ash\n/usr/bin/ash\n' >> install/.bob/busybox.shell-table
    fi
    if kconfigIsSet CONFIG_SHELL_HUSH build/.config; then
        printf '/bin/hush\n/usr/bin/hush\n' >> install/.bob/busybox.shell-table
    fi

    # install udhcpc script if enabled
    if kconfigIsSet CONFIG_UDHCPC build/.config; then
        install -D -m 0755 $<@busybox/udhcpc.script@> install/usr/share/udhcpc/default.script
    fi

packageScript: |
    installCopy "$1/install/"
