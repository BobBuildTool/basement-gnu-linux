inherit: [meson, init]

metaEnvironment:
    PKG_DESCRIPTION: "D-Bus is a simple system for interprocess communication and coordination."
    PKG_LICENSE: "AFL-2.1"
    PKG_VERSION: "1.16.2"

depends:
    - libs::expat-dev
    - libs::glib-dev
    - use: []
      depends:
          - libs::expat-tgt
          - libs::glib-tgt

    - if: "$(eq,${CONFIG_INIT:-},systemd)"
      depends:
          - core::systemd-libsystemd-dev
          - use: []
            name: core::systemd-libsystemd-tgt

checkoutSCM:
    scm: url
    url: https://dbus.freedesktop.org/releases/dbus/dbus-${PKG_VERSION}.tar.xz
    digestSHA1: f44e9a36af548909e46aec8b29b965aeabc3bfbd
    stripComponents: 1

Config:
    DBUS_DEBUG:
        type: bool
        help: Enable DBus verbose mode and assertions.

buildVars: [DBUS_DEBUG]
buildScript: |
    CONFIG_OPTS=(\
        "-Dinotify=enabled"        \
        "-Dxml_docs=disabled"      \
        "-Ddoxygen_docs=disabled"  \
        )

    if [[ "${DBUS_DEBUG:-0}" == 1 ]]; then
        CONFIG_OPTS+=(\
            "-Dverbose_mode=enabled" \
            "-Dasserts=enabled"      \
            "-Dchecks=enabled"       \
            )
    else
        CONFIG_OPTS+=("-Dstats=false")
    fi

    if initIsSystemd ; then
        CONFIG_OPTS+=(
            -Dsystemd=enabled
            -Dsystemd_system_unitdir=/usr/lib/systemd/system
            -Dsystemd_user_unitdir=/usr/lib/systemd/user
        )
    else
        CONFIG_OPTS+=( -Dsystemd=disabled )
    fi

    mesonBuild $1 ${CONFIG_OPTS[@]}

multiPackage:
    "":
        depends:
            - use: []
              name: core::dbus-tgt
        packageScript: |
            mesonPackageBin
            mkdir -p .bob
            cat >.bob/dbus.user-table <<EOF
            messagebus -1 messagebus -1 * /run/dbus - dbus DBus messagebus user
            EOF
        provideDeps: [ "*-tgt" ]
    dev:
        provideDeps: ['*-dev']
        packageScript: mesonPackageDev $1 "/usr/lib/dbus-1.0/***"
    tgt:
        provideDeps: ['*-tgt']
        packageScript: mesonPackageLib
