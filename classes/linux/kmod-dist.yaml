inherit: [linux]

packageVars: [LINUX_ARCH]
packageSetup: |
    _SCRIPT_DIR=$1/kmod-script

    # Install the linux kernel modules distribution for building out-of-tree
    # kernel modules.
    #
    # $1: linux kernel build directory
    linuxInstallKmodDist()
    {
        OUT=$PWD
        # If the kernel itself provides a script for extracting the files required to
        # build external kernel modules, use that, otherwise use the downloaded fixed
        # version.
        # Default is kernel built-in script:
        SCRIPT=$1/source/scripts/package/install-extmod-build
        if [[ ! -e $SCRIPT ]]; then
            SCRIPT=$_SCRIPT_DIR/install-extmod-build
        fi
        pushd $1
        # Newer scripts check for CC != HOSTCC to detect cross compilation. If
        # detected they rebuild the host tools for the target, because the
        # result of install-extmod-build is likely to be executed on the target
        # (e.g. they create .deb packages). This is of course not the case for
        # us, so fake it by unsetting them. This is not a problem because
        # normally nothing for the target gets compiled.
        MAKE=make CC= HOSTCC= SRCARCH=$LINUX_ARCH srctree=$1/source \
            KCONFIG_CONFIG=$1/.config \
            sh "$SCRIPT" "$OUT"
        popd
    }
